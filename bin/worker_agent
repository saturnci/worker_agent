#!/usr/bin/env ruby

require_relative "../lib/worker_agent"
require_relative "../lib/credential"
require_relative "../lib/current_version"

worker_agent = WorkerAgent.new(
  test_runner_id: ENV["TEST_RUNNER_ID"],
  credential: Credential.new(
    host: ENV["SATURNCI_API_HOST"],
    user_id: ENV["TEST_RUNNER_ID"],
    api_token: ENV["TEST_RUNNER_ACCESS_TOKEN"],
  )
)

worker_agent.send_ready_signal
puts "Ready signal sent"

puts "Listening for assignments..."
assignment = worker_agent.listen_for_assignment

if assignment.nil?
  raise "Assignment is blank"
end

puts "Received assignment for run #{assignment["run_id"]}"

puts "Current agent version: #{current_version}"
puts "Performing git pull to ensure latest agent version present..."
system("git pull")
puts "Current agent version: #{current_version}"

worker_agent.execute(assignment)
