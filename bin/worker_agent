#!/usr/bin/env ruby

require_relative "../lib/worker_agent"
require_relative "../lib/saturn_ci_worker_api/client"
require_relative "../lib/current_version"

client = SaturnCIWorkerAPI::Client.new(ENV["SATURNCI_API_HOST"])

worker_agent = WorkerAgent.new(
  test_runner_id: ENV["TEST_RUNNER_ID"],
  client: client
)

worker_agent.send_ready_signal
puts "Ready signal sent"

puts "Listening for assignments..."
assignment = worker_agent.listen_for_assignment

if assignment.nil?
  raise "Assignment is blank"
end

puts "Received assignment for run #{assignment["run_id"]}"

puts "Current agent version: #{current_version}"
puts "Performing git pull to ensure latest agent version present..."
system("git pull")
puts "Current agent version: #{current_version}"

worker_agent.execute(assignment)
